{% extends "base.html" %}

{% block title %}Edit OIDC Provider - Uptimo{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2><i class="bi bi-shield-lock-fill"></i> Edit OIDC Provider: {{ provider.display_name }}</h2>
                <a href="{{ url_for('admin.oidc_providers') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Providers
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <form method="POST" novalidate>
                        {{ form.hidden_tag() }}

                        <!-- Basic Information -->
                        <div class="mb-4">
                            <h5><i class="bi bi-info-circle"></i> Basic Information</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.name.label(class="form-label") }}
                                        {{ form.name(class="form-control" + (" is-invalid" if form.name.errors else "")) }}
                                        {% if form.name.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in form.name.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">{{ form.name.description }}</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.display_name.label(class="form-label") }}
                                        {{ form.display_name(class="form-control" + (" is-invalid" if form.display_name.errors else "")) }}
                                        {% if form.display_name.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in form.display_name.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">{{ form.display_name.description }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Configuration Type -->
                        <div class="mb-4">
                            <h5><i class="bi bi-gear"></i> Configuration Type</h5>
                            <div class="mb-3">
                                {{ form.config_type.label(class="form-label") }}
                                {{ form.config_type(class="form-select" + (" is-invalid" if form.config_type.errors else ""), id="configType") }}
                                {% if form.config_type.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.config_type.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                {% if provider.issuer_url %}
                                <div class="form-text">
                                    <strong>Current configuration:</strong> Auto-discovery from {{ provider.issuer_url }}
                                </div>
                                {% else %}
                                <div class="form-text">
                                    <strong>Current configuration:</strong> Manual endpoints
                                </div>
                                {% endif %}
                            </div>
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i>
                                <strong>Warning:</strong> Changing configuration type may require updating all related fields. 
                                Make sure you have the correct credentials and endpoints before switching.
                            </div>
                        </div>

                        <!-- Auto-discovery Configuration -->
                        <div id="discoveryConfig" class="mb-4{% if not provider.issuer_url %} hidden{% endif %}">
                            <h5><i class="bi bi-radar"></i> Auto-discovery Configuration</h5>
                            <div class="mb-3">
                                {{ form.issuer_url.label(class="form-label") }}
                                {{ form.issuer_url(class="form-control" + (" is-invalid" if form.issuer_url.errors else ""), placeholder="https://accounts.google.com") }}
                                {% if form.issuer_url.errors %}
                                    <div class="invalid-feedback">
                                        {% for error in form.issuer_url.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">{{ form.issuer_url.description }}</div>
                            </div>
                        </div>

                        <!-- Manual Configuration -->
                        <div id="manualConfig" class="mb-4{% if provider.issuer_url %} hidden{% endif %}">
                            <h5><i class="bi bi-gear-fill"></i> Manual Configuration</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.auth_url.label(class="form-label") }}
                                        {{ form.auth_url(class="form-control" + (" is-invalid" if form.auth_url.errors else "")) }}
                                        {% if form.auth_url.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in form.auth_url.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.token_url.label(class="form-label") }}
                                        {{ form.token_url(class="form-control" + (" is-invalid" if form.token_url.errors else "")) }}
                                        {% if form.token_url.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in form.token_url.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.jwks_url.label(class="form-label") }}
                                        {{ form.jwks_url(class="form-control" + (" is-invalid" if form.jwks_url.errors else "")) }}
                                        {% if form.jwks_url.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in form.jwks_url.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.userinfo_url.label(class="form-label") }}
                                        {{ form.userinfo_url(class="form-control" + (" is-invalid" if form.userinfo_url.errors else "")) }}
                                        {% if form.userinfo_url.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in form.userinfo_url.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">{{ form.userinfo_url.description }}</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- OAuth Credentials -->
                        <div class="mb-4">
                            <h5><i class="bi bi-key-fill"></i> OAuth Credentials</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.client_id.label(class="form-label") }}
                                        {{ form.client_id(class="form-control" + (" is-invalid" if form.client_id.errors else "")) }}
                                        {% if form.client_id.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in form.client_id.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">{{ form.client_id.description }}</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.client_secret.label(class="form-label") }}
                                        {{ form.client_secret(class="form-control" + (" is-invalid" if form.client_secret.errors else ""), type="password") }}
                                        {% if form.client_secret.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in form.client_secret.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">{{ form.client_secret.description }}
                                        <br><small class="text-info">â€¢ Secret is masked for security. Leave unchanged to keep existing secret.</small></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Advanced Settings -->
                        <div class="mb-4">
                            <h5><i class="bi bi-sliders"></i> Advanced Settings</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.scope.label(class="form-label") }}
                                        {{ form.scope(class="form-control" + (" is-invalid" if form.scope.errors else "")) }}
                                        {% if form.scope.errors %}
                                            <div class="invalid-feedback">
                                                {% for error in form.scope.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                        <div class="form-text">{{ form.scope.description }}</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <div class="form-check mt-4">
                                            {{ form.is_active(class="form-check-input") }}
                                            {{ form.is_active.label(class="form-check-label") }}
                                            <div class="form-text">{{ form.is_active.description }}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Provider Status -->
                        <div class="mb-4">
                            <h5><i class="bi bi-info-square"></i> Provider Information</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <p><strong>Created:</strong> {{ provider.created_at|local_time('%Y-%m-%d %H:%M') if provider.created_at else 'N/A' }}</p>
                                </div>
                                <div class="col-md-6">
                                    <p><strong>Last Updated:</strong> {{ provider.updated_at|local_time('%Y-%m-%d %H:%M') if provider.updated_at else 'N/A' }}</p>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{{ url_for('admin.oidc_providers') }}" class="btn btn-outline-secondary me-md-2">Cancel</a>
                            {{ form.submit(class="btn btn-primary") }}
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h6><i class="bi bi-info-circle"></i> Help</h6>
                </div>
                <div class="card-body">
                    <h6>Configuration Types</h6>
                    <p><strong>Auto-discovery:</strong> Automatically fetches provider configuration from the issuer URL. Recommended for most providers.</p>
                    <p><strong>Manual:</strong> Requires manual entry of all endpoints. Use when auto-discovery is not available.</p>

                    <h6 class="mt-3">Common Provider URLs</h6>
                    <ul class="small">
                        <li><strong>Google:</strong> https://accounts.google.com</li>
                        <li><strong>Microsoft:</strong> https://login.microsoftonline.com/common/v2.0</li>
                        <li><strong>GitHub:</strong> https://github.com</li>
                        <li><strong>Okta:</strong> https://your-domain.okta.com</li>
                    </ul>

                    <h6 class="mt-3">Security Notes</h6>
                    <ul class="small">
                        <li>Keep client secret secure and never expose it in client-side code</li>
                        <li>Use HTTPS for all redirect URIs</li>
                        <li>Regularly rotate client secrets</li>
                        <li>Test configuration after making changes</li>
                    </ul>

                    <h6 class="mt-3">Testing</h6>
                    <p>After saving changes, test the provider by attempting to log in with a test account to ensure the configuration is correct.</p>
                </div>
            </div>

            <!-- Connected Users -->
            {% if connected_users %}
            <div class="card mt-3">
                <div class="card-header">
                    <h6><i class="bi bi-people"></i> Connected Users ({{ connected_users|length }})</h6>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        {% for user in connected_users %}
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ user.username }}</strong><br>
                                <small class="text-muted">{{ user.email }}</small>
                            </div>
                            <span class="badge bg-{{ 'success' if user.is_active else 'secondary' }}">
                                {{ 'Active' if user.is_active else 'Inactive' }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

{% block scripts %}
<script src="{{ url_for('static', filename='js/oidc-provider.js') }}"></script>
{% endblock %}
{% endblock %}
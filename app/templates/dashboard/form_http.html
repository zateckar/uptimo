{% extends "base.html" %}

{% block title %}{% if monitor %}Edit HTTP Monitor{% else %}Create HTTP Monitor{% endif %} - Uptimo{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/edit-monitor.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-sm">
                <div class="card-header bg-transparent border-bottom d-flex align-items-center justify-content-between py-3">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-globe me-2 text-primary"></i>
                        {% if monitor %}Edit HTTP/HTTPS Monitor{% else %}Create HTTP/HTTPS Monitor{% endif %}
                    </h5>
                    <a href="{{ url_for('dashboard.index') }}" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-x-lg"></i>
                    </a>
                </div>
                <div class="card-body p-4">
                    <form method="POST" class="monitor-form needs-validation">
                        {{ form.hidden_tag() }}
                        {{ form.type(value='http', class='d-none') }}
                        
                        <!-- Basic Information -->
                        <div class="form-section">
                            <h6 class="fw-bold text-uppercase text-muted small mb-4 ls-1">Basic Information</h6>
                            
                            <div class="row g-3">
                                <div class="col-md-12">
                                    {{ form.name.label(class="form-label") }}
                                    {{ form.name(class="form-control", placeholder="e.g. Production API", required=true) }}
                                    {% if form.name.errors %}
                                        <div class="invalid-feedback d-block">{{ form.name.errors[0] }}</div>
                                    {% endif %}
                                </div>
                                
                                <div class="col-md-12">
                                    {{ form.target.label(class="form-label") }}
                                    {{ form.target(class="form-control", placeholder="https://example.com/api/health", required=true) }}
                                    <div class="form-text">Enter the full HTTP or HTTPS URL to monitor</div>
                                    {% if form.target.errors %}
                                        <div class="invalid-feedback d-block">{{ form.target.errors[0] }}</div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Check Settings -->
                        <div class="form-section">
                            <h6 class="fw-bold text-uppercase text-muted small mb-4 ls-1">Check Settings</h6>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    {{ form.check_interval.label(class="form-label") }}
                                    {{ form.check_interval(class="form-select", required=true) }}
                                </div>
                                
                                <div class="col-md-6">
                                    {{ form.timeout.label(class="form-label") }}
                                    <div class="input-group">
                                        {{ form.timeout(class="form-control", required=true) }}
                                        <span class="input-group-text">sec</span>
                                    </div>
                                </div>
                                
                                <div class="col-md-6">
                                    {{ form.response_time_threshold.label(class="form-label") }}
                                    <div class="input-group">
                                        {{ form.response_time_threshold(class="form-control") }}
                                        <span class="input-group-text">ms</span>
                                    </div>
                                    <div class="form-text">Alert if response time exceeds this threshold</div>
                                </div>
                                
                                <div class="col-md-6">
                                    <div class="form-check form-switch mt-4">
                                        {{ form.is_active(class="form-check-input") }}
                                        {{ form.is_active.label(class="form-check-label fw-medium") }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- HTTP Settings -->
                        <div class="form-section">
                            <h6 class="fw-bold text-uppercase text-primary small mb-4 ls-1">
                                <i class="bi bi-globe me-1"></i>HTTP Settings
                            </h6>
                            
                            <div class="row g-3">
                                <div class="col-md-6">
                                    {{ form.http_method.label(class="form-label") }}
                                    {{ form.http_method(class="form-select") }}
                                </div>
                                
                                <div class="col-md-12">
                                    {{ form.expected_status_codes.label(class="form-label") }}
                                    {{ form.expected_status_codes(class="form-control", placeholder="e.g. 200, 201, 301", required=true) }}
                                    <div class="form-text">Comma-separated list of acceptable HTTP status codes</div>
                                </div>
                                
                                <div class="col-md-8">
                                    {{ form.string_match.label(class="form-label") }}
                                    {{ form.string_match(class="form-control", placeholder="Optional text to find in response") }}
                                </div>
                                
                                <div class="col-md-4">
                                    {{ form.string_match_type.label(class="form-label") }}
                                    {{ form.string_match_type(class="form-select") }}
                                </div>
                                
                                <div class="col-md-12">
                                    {{ form.json_path_match.label(class="form-label") }}
                                    {{ form.json_path_match(class="form-control font-monospace", placeholder='{"status": "ok"}') }}
                                    <div class="form-text">JSON path and expected value for validation</div>
                                </div>
                                
                                <div class="col-md-12">
                                    {{ form.http_headers.label(class="form-label") }}
                                    {{ form.http_headers(class="form-control font-monospace", rows="3", placeholder='{"Authorization": "Bearer token"}') }}
                                    <div class="form-text">Custom HTTP headers as JSON object</div>
                                </div>
                                
                                <div class="col-md-12">
                                    {{ form.http_body.label(class="form-label") }}
                                    {{ form.http_body(class="form-control font-monospace", rows="4", placeholder='{"key": "value"}') }}
                                    <div class="form-text">Request body for POST/PUT/PATCH requests</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Advanced Settings -->
                        <div class="form-section">
                            <h6 class="fw-bold text-uppercase text-muted small mb-4 ls-1">Advanced Settings</h6>
                            
                            <div class="row g-3">
                                <div class="col-12">
                                    <span class="badge bg-light text-dark border">TLS/SSL</span>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="form-check form-switch">
                                        {{ form.verify_ssl(class="form-check-input") }}
                                        {{ form.verify_ssl.label(class="form-check-label") }}
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    <div class="form-check form-switch">
                                        {{ form.check_cert_expiration(class="form-check-input") }}
                                        {{ form.check_cert_expiration.label(class="form-check-label") }}
                                    </div>
                                </div>
                                
                                <div class="col-md-4">
                                    {{ form.cert_expiration_threshold.label(class="form-label") }}
                                    <div class="input-group">
                                        {{ form.cert_expiration_threshold(class="form-control") }}
                                        <span class="input-group-text">days</span>
                                    </div>
                                </div>
                                
                                <div class="col-12 mt-3">
                                    <span class="badge bg-light text-dark border">Domain</span>
                                </div>
                                
                                <div class="col-md-5">
                                    <div class="form-check form-switch pt-2">
                                        {{ form.check_domain(class="form-check-input") }}
                                        {{ form.check_domain.label(class="form-check-label") }}
                                    </div>
                                </div>
                                
                                <div class="col-md-7">
                                    {{ form.expected_domain.label(class="form-label") }}
                                    {{ form.expected_domain(class="form-control") }}
                                </div>
                            </div>
                        </div>
                        
                        {% if monitor %}
                        <!-- Notification Settings (only in edit mode) -->
                        <div class="form-section">
                            <h6 class="fw-bold text-uppercase text-success small mb-4 ls-1">
                                <i class="bi bi-bell me-1"></i>Notification Settings
                            </h6>
                            
                            <div class="row g-3">
                                <div class="col-12">
                                    <div class="card border-success">
                                        <div class="card-header bg-light py-2">
                                            <small class="fw-semibold text-success">
                                                <i class="bi bi-info-circle"></i> Configure notification channels for this monitor
                                            </small>
                                        </div>
                                        <div class="card-body">
                                            {% if available_channels %}
                                                <div class="row g-3">
                                                    <div class="col-md-12">
                                                        <label class="form-label">Notification Channels</label>
                                                        <div class="row">
                                                            {% for channel in available_channels %}
                                                                <div class="col-md-6 mb-2">
                                                                    <div class="form-check">
                                                                        <input class="form-check-input" type="checkbox" 
                                                                               name="channel_ids" 
                                                                               value="{{ channel.id }}"
                                                                               id="channel_{{ channel.id }}"
                                                                               {% if notification_form.channel_ids.data and channel.id|string in notification_form.channel_ids.data %}checked{% endif %}>
                                                                        <label class="form-check-label" for="channel_{{ channel.id }}">
                                                                            <span class="badge bg-{{ 'primary' if channel.type.value == 'email' else 'info' if channel.type.value == 'telegram' else 'success' }}">
                                                                                <i class="bi bi-{{ 'envelope' if channel.type.value == 'email' else 'telegram' if channel.type.value == 'telegram' else 'slack' }}"></i>
                                                                                {{ channel.type.value.upper() }}
                                                                            </span>
                                                                            {{ channel.name }}
                                                                        </label>
                                                                    </div>
                                                                </div>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="col-md-6">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" 
                                                                   name="notify_on_down" 
                                                                   id="notify_on_down"
                                                                   {% if notification_form.notify_on_down.data %}checked{% endif %}>
                                                            <label class="form-check-label" for="notify_on_down">
                                                                <i class="bi bi-arrow-down-circle text-danger"></i> Notify when DOWN
                                                            </label>
                                                        </div>
                                                        <div class="form-text">Send alert when monitor fails</div>
                                                    </div>
                                                    
                                                    <div class="col-md-6">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" 
                                                                   name="notify_on_up" 
                                                                   id="notify_on_up"
                                                                   {% if notification_form.notify_on_up.data %}checked{% endif %}>
                                                            <label class="form-check-label" for="notify_on_up">
                                                                <i class="bi bi-arrow-up-circle text-success"></i> Notify when UP
                                                            </label>
                                                        </div>
                                                        <div class="form-text">Send recovery notification</div>
                                                    </div>
                                                    
                                                    <div class="col-md-6">
                                                        <div class="form-check form-switch">
                                                            <input class="form-check-input" type="checkbox" 
                                                                   name="notify_on_ssl_warning" 
                                                                   id="notify_on_ssl_warning"
                                                                   {% if notification_form.notify_on_ssl_warning.data %}checked{% endif %}>
                                                            <label class="form-check-label" for="notify_on_ssl_warning">
                                                                <i class="bi bi-shield-exclamation text-warning"></i> SSL warnings
                                                            </label>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="col-md-3">
                                                        <label class="form-label">Consecutive failures</label>
                                                        <input class="form-control" type="number" 
                                                               name="consecutive_checks_threshold" 
                                                               value="{{ notification_form.consecutive_checks_threshold.data or 1 }}"
                                                               min="1" max="10">
                                                        <div class="form-text">Min failures before alert</div>
                                                    </div>
                                                    
                                                    <div class="col-md-3">
                                                        <label class="form-label">Escalate after (min)</label>
                                                        <input class="form-control" type="number" 
                                                               name="escalate_after_minutes" 
                                                               value="{{ notification_form.escalate_after_minutes.data or '' }}"
                                                               min="1" placeholder="Optional">
                                                        <div class="form-text">Re-alert after X minutes</div>
                                                    </div>
                                                </div>
                                                
                                                <div class="mt-3">
                                                    <button type="submit" name="form_type" value="notifications" 
                                                            class="btn btn-success btn-sm">
                                                        <i class="bi bi-bell"></i> Save Notification Settings
                                                    </button>
                                                </div>
                                            {% else %}
                                                <div class="text-center py-3">
                                                    <i class="bi bi-bell-slash text-muted icon-2xl"></i>
                                                    <p class="text-muted mb-2">No notification channels configured</p>
                                                    <a href="{{ url_for('notifications.create_channel') }}" 
                                                       class="btn btn-outline-primary btn-sm">
                                                        <i class="bi bi-plus-circle"></i> Create Channel
                                                    </a>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Delete and Clone Buttons (only in edit mode) -->
                        <div class="d-flex justify-content-between gap-2 pt-3 border-top">
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-outline-danger" id="deleteMonitorBtn">
                                    <i class="bi bi-trash me-1"></i>Delete Monitor
                                </button>
                                <button type="button" class="btn btn-outline-primary" id="cloneMonitorBtn">
                                    <i class="bi bi-files me-1"></i>Clone
                                </button>
                            </div>
                            <div class="d-flex gap-2">
                                <a href="{{ url_for('dashboard.index') }}" class="btn btn-outline-secondary">Cancel</a>
                                {{ form.submit(class="btn btn-primary px-4", value="Update Monitor") }}
                            </div>
                        </div>
                        {% else %}
                        <!-- Create Form Actions -->
                        <div class="d-flex justify-content-end gap-2 pt-3 border-top">
                            <a href="{{ url_for('dashboard.index') }}" class="btn btn-outline-secondary">Cancel</a>
                            {{ form.submit(class="btn btn-primary px-4", value="Create Monitor") }}
                        </div>
                        {% endif %}
                    </form>
                    
                    {% if monitor %}
                    <!-- Delete and Clone Forms (outside main form to avoid nesting) -->
                    <form id="deleteForm" method="POST" action="{{ url_for('dashboard.delete', id=monitor.id) }}" class="d-none">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    </form>
                    <form id="cloneForm" method="POST" action="{{ url_for('dashboard.clone', id=monitor.id) }}" class="d-none">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    </form>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/feedback.js') }}"></script>
<script src="{{ url_for('static', filename='js/form-handler.js') }}"></script>
{% endblock %}
